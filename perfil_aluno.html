{% extends "base.html" %}

{% block title %}Meu Perfil - {{ aluno.nome }} - {{ super() }}{% endblock %}

{% block head_extra %}
<style>
  .profile-header {
    background: var(--gradient-main);
    border-radius: 20px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .profile-header::before {
    content: '';
    position: absolute;
    top: -50px;
    right: -50px;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
  }

  .profile-avatar {
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
    border: 4px solid rgba(255, 255, 255, 0.3);
    margin: 0 auto;
  }

  .info-card {
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .info-card:hover {
    background: rgba(255, 255, 255, 0.12) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(111, 66, 193, 0.2) !important;
  }

  .info-item {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .info-item:last-child {
    border-bottom: none;
  }

  .info-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .info-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
  }

  .profile-actions {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 1.5rem;
  }

  .action-btn {
    border-radius: 12px !important;
    padding: 1rem 1.5rem !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    border: 2px solid transparent !important;
  }

  .action-btn:hover {
    transform: translateY(-2px) !important;
  }

  .settings-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 2rem;
  }

  .settings-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .settings-item:last-child {
    border-bottom: none;
  }

  .back-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    transition: all 0.3s ease !important;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: translateX(-3px) !important;
    color: white !important;
  }

  @media (max-width: 768px) {
    .profile-header {
      padding: 1.5rem;
    }

    .profile-avatar {
      width: 90px;
      height: 90px;
      font-size: 2.2rem;
    }

    .info-item {
      padding: 1rem;
    }

    .profile-actions,
    .settings-section {
      padding: 1rem;
    }
  }

  @media (max-width: 480px) {
    .profile-header {
      padding: 1rem;
    }

    .profile-avatar {
      width: 70px;
      height: 70px;
      font-size: 1.8rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<div class="profile-header text-white">
  <div class="row align-items-center">
    <div class="col-auto">
      <a href="/meu-historico" class="btn back-btn">
        <i class="bi bi-arrow-left me-2"></i>
        Voltar
      </a>
    </div>
    <div class="col">
      <div class="row align-items-center">
        <div class="col-12 col-md-3 text-center mb-3 mb-md-0">
          <div class="profile-avatar">
            <i class="bi bi-person"></i>
          </div>
        </div>
        <div class="col-12 col-md-9">
          <h2 class="h3 mb-2">{{ aluno.nome }}</h2>
          <p class="mb-2 opacity-75">
            <i class="bi bi-envelope me-2"></i>
            {{ aluno.email or 'Email não informado' }}
          </p>
          <div class="d-flex flex-wrap gap-3">
            <span class="badge bg-light text-dark px-3 py-2">
              <i class="bi bi-person-check me-1"></i>
              {% if aluno.ativo %}Conta Ativa{% else %}Conta Inativa{% endif %}
            </span>
            <span class="badge bg-primary px-3 py-2">
              <i class="bi bi-hash me-1"></i>
              ID: {{ aluno.id }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Information -->
<div class="row g-4">
  <div class="col-12 col-lg-8">
    <div class="card info-card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-info-circle me-2"></i>
          Informações Pessoais
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="info-item">
          <div class="info-label">
            <i class="bi bi-person"></i>
            Nome Completo
          </div>
          <div class="info-value">{{ aluno.nome }}</div>
        </div>

        <div class="info-item">
          <div class="info-label">
            <i class="bi bi-envelope"></i>
            Email
          </div>
          <div class="info-value">
            {{ aluno.email or 'Não informado' }}
            {% if not aluno.email %}
              <small class="text-warning ms-2">
                <i class="bi bi-exclamation-triangle"></i>
                Email não cadastrado
              </small>
            {% endif %}
          </div>
        </div>

        <div class="info-item">
          <div class="info-label">
            <i class="bi bi-calendar-plus"></i>
            Data de Cadastro
          </div>
          <div class="info-value">
            {% if aluno.created_at %}
              {{ aluno.created_at.strftime('%d/%m/%Y às %H:%M') }}
            {% else %}
              Não disponível
            {% endif %}
          </div>
        </div>

        <div class="info-item">
          <div class="info-label">
            <i class="bi bi-shield-check"></i>
            Status da Conta
          </div>
          <div class="info-value">
            {% if aluno.ativo %}
              <span class="badge bg-success px-3 py-2">
                <i class="bi bi-check-circle me-1"></i>
                Ativa
              </span>
            {% else %}
              <span class="badge bg-warning px-3 py-2">
                <i class="bi bi-pause-circle me-1"></i>
                Inativa
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <!-- Quick Actions -->
    <div class="profile-actions">
      <h6 class="mb-3">
        <i class="bi bi-lightning me-2"></i>
        Ações Rápidas
      </h6>
      <div class="d-grid gap-3">
        <a href="/formulario" class="btn btn-primary action-btn">
          <i class="bi bi-plus-circle me-2"></i>
          Nova Avaliação
        </a>
        <a href="/meu-historico" class="btn btn-outline-light action-btn">
          <i class="bi bi-clock-history me-2"></i>
          Meu Histórico
        </a>
        <button class="btn btn-success action-btn" onclick="exportProfile()">
          <i class="bi bi-download me-2"></i>
          Exportar Dados
        </button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="mt-4">
      <div class="card info-card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-graph-up me-2"></i>
            Estatísticas Rápidas
          </h6>
        </div>
        <div class="card-body text-center" id="quickStats">
          <div class="text-muted">
            <div class="spinner-border spinner-border-sm me-2"></div>
            Carregando estatísticas...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Section -->
<div class="settings-section">
  <h5 class="mb-4">
    <i class="bi bi-gear me-2"></i>
    Configurações da Conta
  </h5>
  <div class="row g-4">
    <div class="col-12 col-md-6">
      <div class="settings-item">
        <div class="d-flex align-items-center">
          <i class="bi bi-shield-lock me-3 text-warning fs-5"></i>
          <div>
            <strong>Alterar Senha</strong>
            <br><small class="text-muted">Mantenha sua conta segura</small>
          </div>
        </div>
        <button class="btn btn-sm btn-outline-warning" onclick="changePassword()">
          Alterar
        </button>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="settings-item">
        <div class="d-flex align-items-center">
          <i class="bi bi-bell me-3 text-info fs-5"></i>
          <div>
            <strong>Notificações</strong>
            <br><small class="text-muted">Receber lembretes de avaliação</small>
          </div>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="notifications" checked>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="row mt-5">
  <div class="col-12 text-center">
    <div class="d-flex flex-wrap gap-3 justify-content-center">
      <a href="/meu-historico" class="btn btn-outline-light btn-lg">
        <i class="bi bi-arrow-left me-2"></i>
        Voltar ao Histórico
      </a>
      <a href="/formulario" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle me-2"></i>
        Nova Avaliação
      </a>
      <a href="/logout" class="btn btn-outline-danger">
        <i class="bi bi-box-arrow-right me-2"></i>
        Sair da Conta
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load quick statistics
async function loadQuickStats() {
  const statsDiv = document.getElementById('quickStats');

  try {
    // Simulate API call - replace with actual endpoint
    await new Promise(resolve => setTimeout(resolve, 1500));

    // Placeholder data - replace with actual API call
    const mockStats = {
      totalAvaliacoes: Math.floor(Math.random() * 20) + 1,
      ultimaAvaliacao: '15/03/2024',
      imcAtual: (Math.random() * 10 + 20).toFixed(1)
    };

    statsDiv.innerHTML = `
      <div class="row g-3 text-center">
        <div class="col-4">
          <div class="h4 mb-1 text-primary">${mockStats.totalAvaliacoes}</div>
          <small class="text-muted">Avaliações</small>
        </div>
        <div class="col-4">
          <div class="h4 mb-1 text-success">${mockStats.imcAtual}</div>
          <small class="text-muted">IMC Atual</small>
        </div>
        <div class="col-4">
          <div class="h6 mb-1 text-info">${mockStats.ultimaAvaliacao}</div>
          <small class="text-muted">Última</small>
        </div>
      </div>
    `;
  } catch (error) {
    statsDiv.innerHTML = `
      <div class="text-muted">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Erro ao carregar estatísticas
      </div>
    `;
  }
}

// Export profile data
function exportProfile() {
  const btn = event.target;
  const originalText = btn.innerHTML;

  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exportando...';
  btn.disabled = true;

  setTimeout(() => {
    alert('Funcionalidade de exportação será implementada em breve!\n\nVocê poderá exportar:\n• Dados pessoais\n• Histórico de avaliações\n• Gráficos de progresso');
    btn.innerHTML = originalText;
    btn.disabled = false;
  }, 2000);
}

// Change password functionality
function changePassword() {
  alert('Funcionalidade de alteração de senha será implementada em breve!\n\nPor enquanto, entre em contato com o administrador para alterar sua senha.');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  // Load quick stats
  loadQuickStats();

  // Add smooth loading states to navigation
  document.querySelectorAll('a[href^="/"]').forEach(link => {
    link.addEventListener('click', function(e) {
      if (!this.target || this.target === '_self') {
        if (this.classList.contains('btn')) {
          const original = this.innerHTML;
          const icon = this.querySelector('i');
          const iconClass = icon ? icon.className : 'bi bi-arrow-right';

          this.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Carregando...`;
          this.style.pointerEvents = 'none';
        }
      }
    });
  });

  // Animate cards on scroll
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);

  document.querySelectorAll('.info-card, .profile-actions, .settings-section').forEach((element, index) => {
    element.style.opacity = '0';
    element.style.transform = 'translateY(20px)';
    element.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
    observer.observe(element);
  });

  // Handle notification toggle
  document.getElementById('notifications').addEventListener('change', function() {
    const isChecked = this.checked;

    // Show feedback
    const Toast = {
      show: (message) => {
        const toast = document.createElement('div');
        toast.className = 'toast position-fixed top-0 start-50 translate-middle-x mt-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
          <div class="toast-body bg-primary text-white rounded">
            ${message}
          </div>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    };

    if (isChecked) {
      Toast.show('<i class="bi bi-bell me-2"></i>Notificações ativadas!');
    } else {
      Toast.show('<i class="bi bi-bell-slash me-2"></i>Notificações desativadas.');
    }
  });
});
</script>
{% endblock %}