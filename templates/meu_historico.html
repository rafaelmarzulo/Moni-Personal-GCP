{% extends "base.html" %}

{% block title %}Meu Histórico - {{ aluno.nome }} - {{ super() }}{% endblock %}

{% block head_extra %}
<style>
  .personal-header {
    background: var(--gradient-main);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .personal-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 150px;
    height: 150px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(30px, -30px);
  }

  .evaluation-card {
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
  }

  .evaluation-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--gradient-main);
  }

  .evaluation-card:hover {
    background: rgba(255, 255, 255, 0.12) !important;
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(111, 66, 193, 0.25) !important;
  }

  .imc-indicator {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
    margin: 0 auto;
  }

  .imc-baixo {
    background: rgba(54, 162, 235, 0.2);
    color: #36a2eb;
    border: 2px solid #36a2eb;
  }
  .imc-normal {
    background: rgba(75, 192, 192, 0.2);
    color: #4bc0c0;
    border: 2px solid #4bc0c0;
  }
  .imc-sobrepeso {
    background: rgba(255, 206, 86, 0.2);
    color: #ffce56;
    border: 2px solid #ffce56;
  }
  .imc-obeso {
    background: rgba(255, 99, 132, 0.2);
    color: #ff6384;
    border: 2px solid #ff6384;
  }

  .progress-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .metric-card {
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 15px;
    transition: all 0.3s ease;
  }

  .metric-card:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
  }

  .metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-gold);
  }

  .metric-trend {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
  }

  .metric-trend i {
    font-size: 0.9rem;
  }

  .metric-trend small {
    font-size: 0.75rem;
    font-weight: 600;
  }

  .insight-item {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
  }

  .insight-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-left-color: var(--primary-gold);
    transform: translateX(3px);
  }

  .insight-item i {
    font-size: 1.1rem;
  }

  .success-alert {
    background: rgba(75, 192, 192, 0.1) !important;
    border: 1px solid rgba(75, 192, 192, 0.3) !important;
    color: #4bc0c0 !important;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 1rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .empty-state i {
    font-size: 5rem;
    opacity: 0.3;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .personal-header {
      padding: 1.5rem;
    }

    .imc-indicator {
      width: 50px;
      height: 50px;
      font-size: 0.8rem;
    }

    .metric-value {
      font-size: 1.2rem;
    }

    .evaluation-card {
      margin-bottom: 1rem;
    }

    .metric-card {
      margin-bottom: 1rem;
    }

    .metric-trend {
      margin-top: 0.25rem;
    }

    .metric-trend small {
      font-size: 0.7rem;
    }

    .insight-item {
      padding: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .insight-item strong {
      display: block;
      margin-bottom: 0.25rem;
    }

    /* Stack chart cards vertically on mobile */
    .row.g-4 .col-md-6 {
      margin-bottom: 1.5rem;
    }

    /* Adjust chart height for mobile */
    canvas {
      height: 200px !important;
    }
  }

  @media (max-width: 480px) {
    .personal-header {
      padding: 1rem;
    }

    .progress-section {
      padding: 1rem;
    }

    .metric-value {
      font-size: 1rem;
    }

    .metric-card {
      padding: 0.75rem;
    }

    /* Make evaluation cards more compact */
    .evaluation-card .card-body {
      padding: 1rem 0.75rem;
    }

    .evaluation-card .row.g-3 {
      --bs-gutter-x: 0.5rem;
      --bs-gutter-y: 0.75rem;
    }

    /* Smaller text in cards */
    .evaluation-card small {
      font-size: 0.75rem;
    }

    .evaluation-card strong {
      font-size: 0.9rem;
    }

    /* Compact insights */
    .insight-item {
      padding: 0.5rem;
      font-size: 0.85rem;
    }

    .insight-item i {
      font-size: 1rem;
    }

    /* Adjust button spacing */
    .d-flex.gap-3 {
      gap: 0.5rem !important;
      flex-direction: column;
    }

    .btn {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Success message -->
{% if request.query_params.get('success') %}
  <div class="alert success-alert alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>
    <strong>Sucesso!</strong> Sua nova avaliação foi registrada com sucesso.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

<!-- Personal Header -->
<div class="personal-header text-white">
  <div class="row align-items-center">
    <div class="col-12 col-md-8">
      <h2 class="h3 mb-3">
        <i class="bi bi-person-heart me-2"></i>
        Meu Histórico Pessoal
      </h2>
      <div class="row g-3">
        <div class="col-12 col-sm-6">
          <small class="opacity-75">Bem-vindo(a)</small>
          <div class="fw-semibold fs-5">{{ aluno.nome }}</div>
        </div>
        <div class="col-12 col-sm-6">
          <small class="opacity-75">Total de Avaliações</small>
          <div class="fw-semibold fs-5">{{ total_avaliacoes }} registros</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4 text-center text-md-end mt-3 mt-md-0">
      <a href="/formulario" class="btn btn-light btn-lg">
        <i class="bi bi-plus-circle me-2"></i>
        Nova Avaliação
      </a>
    </div>
  </div>
</div>

{% if avaliacoes %}
  <!-- Enhanced Progress Overview -->
  <div class="progress-section">
    <h5 class="mb-4 text-center">
      <i class="bi bi-graph-up me-2"></i>
      Resumo do seu Progresso
    </h5>
    <div class="row g-3 mb-4">
      {% if avaliacoes|length > 0 %}
        {% set latest = avaliacoes[0] %}
        {% set oldest = avaliacoes[-1] if avaliacoes|length > 1 else avaliacoes[0] %}

        <div class="col-6 col-md-3">
          <div class="metric-card">
            <div class="metric-value">{{ "%.1f"|format(latest.peso_kg) if latest.peso_kg else 'N/A' }}</div>
            <small class="text-muted">Peso Atual (kg)</small>
            {% if avaliacoes|length > 1 %}
              {% set peso_diff = latest.peso_kg - oldest.peso_kg if latest.peso_kg and oldest.peso_kg else 0 %}
              <div class="metric-trend">
                {% if peso_diff > 0 %}
                  <i class="bi bi-arrow-up text-warning"></i>
                  <small class="text-warning">+{{ "%.1f"|format(peso_diff) }}kg</small>
                {% elif peso_diff < 0 %}
                  <i class="bi bi-arrow-down text-success"></i>
                  <small class="text-success">{{ "%.1f"|format(peso_diff) }}kg</small>
                {% else %}
                  <i class="bi bi-dash text-info"></i>
                  <small class="text-info">Estável</small>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="metric-card">
            <div class="metric-value">{{ "%.1f"|format(latest.imc) if latest.imc else 'N/A' }}</div>
            <small class="text-muted">IMC Atual</small>
            {% if avaliacoes|length > 1 and latest.imc and oldest.imc %}
              {% set imc_diff = latest.imc - oldest.imc %}
              <div class="metric-trend">
                {% if imc_diff > 0 %}
                  <i class="bi bi-arrow-up {% if latest.imc > 25 %}text-warning{% else %}text-primary{% endif %}"></i>
                  <small class="{% if latest.imc > 25 %}text-warning{% else %}text-primary{% endif %}">+{{ "%.1f"|format(imc_diff) }}</small>
                {% elif imc_diff < 0 %}
                  <i class="bi bi-arrow-down text-success"></i>
                  <small class="text-success">{{ "%.1f"|format(imc_diff) }}</small>
                {% else %}
                  <i class="bi bi-dash text-info"></i>
                  <small class="text-info">Estável</small>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="metric-card">
            <div class="metric-value text-primary">{{ avaliacoes|length }}</div>
            <small class="text-muted">Total Avaliações</small>
            {% if avaliacoes|length >= 5 %}
              <div class="metric-trend">
                <i class="bi bi-trophy text-warning"></i>
                <small class="text-warning">Consistente!</small>
              </div>
            {% elif avaliacoes|length >= 3 %}
              <div class="metric-trend">
                <i class="bi bi-graph-up text-success"></i>
                <small class="text-success">Progredindo</small>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="metric-card">
            {% if avaliacoes[0].data_local %}
              {% set today = avaliacoes[0].data_local.date() %}
              {% set last_eval = avaliacoes[0].data_local.date() %}
              {% set days_since = (today - last_eval).days %}
              <div class="metric-value text-info">{{ days_since if days_since > 0 else 'Hoje' }}</div>
              <small class="text-muted">{{ 'Dias atrás' if days_since > 0 else 'Última Avaliação' }}</small>
              <div class="metric-trend">
                {% if days_since == 0 %}
                  <i class="bi bi-calendar-check text-success"></i>
                  <small class="text-success">Hoje!</small>
                {% elif days_since <= 7 %}
                  <i class="bi bi-calendar-week text-primary"></i>
                  <small class="text-primary">Recente</small>
                {% elif days_since <= 30 %}
                  <i class="bi bi-calendar-month text-warning"></i>
                  <small class="text-warning">Este mês</small>
                {% else %}
                  <i class="bi bi-calendar-x text-danger"></i>
                  <small class="text-danger">Há tempo</small>
                {% endif %}
              </div>
            {% else %}
              <div class="metric-value text-info">N/A</div>
              <small class="text-muted">Última Avaliação</small>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Progress Charts Section -->
    {% if avaliacoes|length > 1 %}
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-graph-up me-2"></i>
              Evolução do Peso
            </h6>
          </div>
          <div class="card-body">
            <canvas id="weightChart" style="height: 250px;"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-speedometer2 me-2"></i>
              Evolução do IMC
            </h6>
          </div>
          <div class="card-body">
            <canvas id="imcChart" style="height: 250px;"></canvas>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Progress Insights -->
    {% if avaliacoes|length > 1 %}
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-lightbulb me-2"></i>
              Insights do seu Progresso
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              {% set latest = avaliacoes[0] %}
              {% set previous = avaliacoes[1] if avaliacoes|length > 1 else None %}
              {% set oldest = avaliacoes[-1] %}

              {% if previous %}
                <!-- Recent Progress -->
                <div class="col-md-6">
                  <div class="insight-item">
                    <i class="bi bi-calendar-week text-primary me-2"></i>
                    <strong>Progresso Recente:</strong>
                    {% set recent_weight_diff = latest.peso_kg - previous.peso_kg if latest.peso_kg and previous.peso_kg else 0 %}
                    {% if recent_weight_diff > 0.5 %}
                      <span class="text-warning">Ganhou {{ "%.1f"|format(recent_weight_diff) }}kg desde a última avaliação</span>
                    {% elif recent_weight_diff < -0.5 %}
                      <span class="text-success">Perdeu {{ "%.1f"|format(-recent_weight_diff) }}kg desde a última avaliação</span>
                    {% else %}
                      <span class="text-info">Peso estável desde a última avaliação</span>
                    {% endif %}
                  </div>
                </div>
              {% endif %}

              <!-- Overall Trend -->
              <div class="col-md-6">
                <div class="insight-item">
                  <i class="bi bi-graph-up text-success me-2"></i>
                  <strong>Tendência Geral:</strong>
                  {% set total_weight_diff = latest.peso_kg - oldest.peso_kg if latest.peso_kg and oldest.peso_kg else 0 %}
                  {% if total_weight_diff > 2 %}
                    <span class="text-warning">Ganho de peso significativo ({{ "%.1f"|format(total_weight_diff) }}kg)</span>
                  {% elif total_weight_diff < -2 %}
                    <span class="text-success">Perda de peso significativa ({{ "%.1f"|format(-total_weight_diff) }}kg)</span>
                  {% elif total_weight_diff <= 2 and total_weight_diff >= -2 %}
                    <span class="text-info">Peso mantido com variação normal</span>
                  {% endif %}
                </div>
              </div>

              <!-- IMC Status -->
              {% if latest.imc %}
              <div class="col-md-6">
                <div class="insight-item">
                  <i class="bi bi-speedometer2 text-info me-2"></i>
                  <strong>Status IMC:</strong>
                  {% if latest.imc < 18.5 %}
                    <span class="text-primary">Abaixo do peso ideal - considere ganhar massa</span>
                  {% elif latest.imc <= 24.9 %}
                    <span class="text-success">Peso ideal - continue mantendo!</span>
                  {% elif latest.imc <= 29.9 %}
                    <span class="text-warning">Sobrepeso - foque em exercícios e alimentação</span>
                  {% else %}
                    <span class="text-danger">Obesidade - recomenda-se acompanhamento profissional</span>
                  {% endif %}
                </div>
              </div>
              {% endif %}

              <!-- Consistency -->
              <div class="col-md-6">
                <div class="insight-item">
                  <i class="bi bi-award text-warning me-2"></i>
                  <strong>Constância:</strong>
                  {% if avaliacoes|length >= 10 %}
                    <span class="text-success">Excelente! Mais de 10 avaliações registradas</span>
                  {% elif avaliacoes|length >= 5 %}
                    <span class="text-primary">Bom progresso! Continue registrando</span>
                  {% elif avaliacoes|length >= 3 %}
                    <span class="text-warning">Começando bem! Tente avaliar regularmente</span>
                  {% else %}
                    <span class="text-info">Início da jornada - registre mais avaliações</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Evaluations History -->
  <div class="row">
    <div class="col-12">
      <h4 class="mb-4">
        <i class="bi bi-calendar-event me-2"></i>
        Minhas Avaliações
      </h4>

      {% for avaliacao in avaliacoes %}
        <div class="evaluation-card card">
          <div class="card-body">
            <div class="row g-3 align-items-center">
              <!-- Date -->
              <div class="col-12 col-sm-6 col-md-3">
                <div class="d-flex flex-column">
                  <strong class="text-primary fs-5">
                    {% if avaliacao.data_local %}
                      {{ avaliacao.data_local.strftime('%d/%m/%Y') }}
                    {% else %}
                      {{ avaliacao.data_avaliacao.strftime('%d/%m/%Y') if avaliacao.data_avaliacao else 'Data não informada' }}
                    {% endif %}
                  </strong>
                  <small class="text-muted">
                    {% if avaliacao.data_local %}
                      {{ avaliacao.data_local.strftime('%H:%M') }}
                    {% elif avaliacao.data_avaliacao %}
                      {{ avaliacao.data_avaliacao.strftime('%H:%M') }}
                    {% endif %}
                  </small>
                </div>
              </div>

              <!-- Physical Metrics -->
              <div class="col-6 col-sm-3 col-md-2">
                <small class="text-muted d-block">Peso</small>
                <strong class="fs-5">{{ "%.1f"|format(avaliacao.peso_kg) if avaliacao.peso_kg else 'N/A' }}</strong>
                <small class="text-muted"> kg</small>
              </div>

              <div class="col-6 col-sm-3 col-md-2">
                <small class="text-muted d-block">Altura</small>
                <strong class="fs-5">{{ "%.0f"|format(avaliacao.altura_cm) if avaliacao.altura_cm else 'N/A' }}</strong>
                <small class="text-muted"> cm</small>
              </div>

              <!-- IMC Indicator -->
              <div class="col-12 col-sm-6 col-md-2">
                {% if avaliacao.imc %}
                  {% set imc_class = "imc-normal" %}
                  {% set imc_label = "Normal" %}
                  {% if avaliacao.imc < 18.5 %}
                    {% set imc_class = "imc-baixo" %}
                    {% set imc_label = "Baixo" %}
                  {% elif avaliacao.imc >= 25 and avaliacao.imc < 30 %}
                    {% set imc_class = "imc-sobrepeso" %}
                    {% set imc_label = "Sobrepeso" %}
                  {% elif avaliacao.imc >= 30 %}
                    {% set imc_class = "imc-obeso" %}
                    {% set imc_label = "Obesidade" %}
                  {% endif %}
                  <div class="text-center">
                    <div class="imc-indicator {{ imc_class }}">
                      {{ "%.1f"|format(avaliacao.imc) }}
                    </div>
                    <small class="text-muted d-block mt-1">{{ imc_label }}</small>
                  </div>
                {% else %}
                  <div class="text-center text-muted">
                    <div class="imc-indicator border">N/A</div>
                    <small class="d-block mt-1">IMC</small>
                  </div>
                {% endif %}
              </div>

              <!-- Observations -->
              {% if avaliacao.observacoes_medidas %}
                <div class="col-12 col-md-3">
                  <small class="text-muted d-block">Observações</small>
                  <div class="mt-1">
                    {% if avaliacao.observacoes_medidas|length > 60 %}
                      <span class="d-inline-block" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ avaliacao.observacoes_medidas }}">
                        {{ avaliacao.observacoes_medidas[:60] }}...
                      </span>
                    {% else %}
                      {{ avaliacao.observacoes_medidas }}
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mt-4">
    <div class="col-12 text-center">
      <div class="d-flex flex-wrap gap-3 justify-content-center">
        <a href="/formulario" class="btn btn-primary btn-lg">
          <i class="bi bi-plus-circle me-2"></i>
          Nova Avaliação
        </a>
        <a href="/perfil" class="btn btn-outline-light">
          <i class="bi bi-person me-2"></i>
          Meu Perfil
        </a>
        <button class="btn btn-success" onclick="exportMyData()">
          <i class="bi bi-download me-2"></i>
          Exportar Dados
        </button>
      </div>
    </div>
  </div>

{% else %}
  <!-- Empty State -->
  <div class="empty-state">
    <i class="bi bi-clipboard-plus display-1 mb-4"></i>
    <h3>Que tal registrar sua primeira avaliação?</h3>
    <p class="lead mb-4">Comece agora a acompanhar seu progresso físico!</p>
    <a href="/formulario" class="btn btn-primary btn-lg">
      <i class="bi bi-plus-circle me-2"></i>
      Fazer Minha Primeira Avaliação
    </a>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart data preparation
const avaliacoes = {{ avaliacoes|tojson if avaliacoes else '[]' }};

// Sort evaluations by date (oldest first for charts)
const sortedAvaliacoes = [...avaliacoes].reverse();

// Prepare chart data
const chartLabels = sortedAvaliacoes.map(av => {
  const date = new Date(av.data_local || av.data_avaliacao);
  return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
});

const weightData = sortedAvaliacoes.map(av => av.peso_kg || null);
const imcData = sortedAvaliacoes.map(av => av.imc || null);

// Chart configuration
const chartConfig = {
  type: 'line',
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        backgroundColor: 'rgba(26, 26, 26, 0.9)',
        titleColor: '#ffffff',
        bodyColor: '#ffffff',
        borderColor: 'var(--primary-gold)',
        borderWidth: 1,
        cornerRadius: 8,
        displayColors: false
      }
    },
    scales: {
      x: {
        grid: {
          color: 'rgba(255, 255, 255, 0.1)'
        },
        ticks: {
          color: 'rgba(255, 255, 255, 0.7)',
          font: {
            size: 11
          }
        }
      },
      y: {
        grid: {
          color: 'rgba(255, 255, 255, 0.1)'
        },
        ticks: {
          color: 'rgba(255, 255, 255, 0.7)',
          font: {
            size: 11
          }
        }
      }
    },
    elements: {
      line: {
        tension: 0.4,
        borderWidth: 3
      },
      point: {
        radius: 6,
        hoverRadius: 8,
        borderWidth: 2,
        backgroundColor: '#ffffff'
      }
    }
  }
};

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Weight Chart
  if (avaliacoes.length > 1) {
    const weightCtx = document.getElementById('weightChart');
    if (weightCtx) {
      new Chart(weightCtx, {
        ...chartConfig,
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Peso (kg)',
            data: weightData,
            borderColor: 'var(--primary-gold)',
            backgroundColor: 'var(--primary-gold)',
            fill: false
          }]
        },
        options: {
          ...chartConfig.options,
          scales: {
            ...chartConfig.options.scales,
            y: {
              ...chartConfig.options.scales.y,
              title: {
                display: true,
                text: 'Peso (kg)',
                color: 'rgba(255, 255, 255, 0.7)',
                font: {
                  size: 12,
                  weight: 'bold'
                }
              }
            }
          }
        }
      });
    }

    // IMC Chart
    const imcCtx = document.getElementById('imcChart');
    if (imcCtx) {
      new Chart(imcCtx, {
        ...chartConfig,
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'IMC',
            data: imcData,
            borderColor: '#4bc0c0',
            backgroundColor: '#4bc0c0',
            fill: false
          }]
        },
        options: {
          ...chartConfig.options,
          scales: {
            ...chartConfig.options.scales,
            y: {
              ...chartConfig.options.scales.y,
              title: {
                display: true,
                text: 'IMC',
                color: 'rgba(255, 255, 255, 0.7)',
                font: {
                  size: 12,
                  weight: 'bold'
                }
              },
              min: 15,
              max: 35,
              // Add IMC reference lines
              afterDraw: function(chart) {
                const ctx = chart.ctx;
                const yAxis = chart.scales.y;

                // IMC reference lines
                const references = [
                  { value: 18.5, color: '#36a2eb', label: 'Baixo peso' },
                  { value: 25, color: '#4bc0c0', label: 'Normal' },
                  { value: 30, color: '#ffce56', label: 'Sobrepeso' }
                ];

                references.forEach(ref => {
                  const y = yAxis.getPixelForValue(ref.value);
                  ctx.save();
                  ctx.strokeStyle = ref.color;
                  ctx.setLineDash([5, 5]);
                  ctx.lineWidth = 1;
                  ctx.beginPath();
                  ctx.moveTo(chart.chartArea.left, y);
                  ctx.lineTo(chart.chartArea.right, y);
                  ctx.stroke();
                  ctx.restore();
                });
              }
            }
          }
        }
      });
    }
  }
});

// Export functionality
function exportMyData() {
  // Show loading state
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exportando...';
  btn.disabled = true;

  // Simulate export process
  setTimeout(() => {
    alert('Funcionalidade de exportação será implementada em breve!\n\nVocê poderá exportar seus dados em formato PDF ou CSV.');
    btn.innerHTML = originalText;
    btn.disabled = false;
  }, 2000);
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
  // Bootstrap tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Animate cards on scroll
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);

  document.querySelectorAll('.evaluation-card').forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(30px)';
    card.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
    observer.observe(card);
  });

  // Add loading states to navigation links
  document.querySelectorAll('a[href^="/"]').forEach(link => {
    link.addEventListener('click', function(e) {
      if (!this.target || this.target === '_self') {
        if (this.classList.contains('btn')) {
          const original = this.innerHTML;
          this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + this.textContent;
          this.style.pointerEvents = 'none';
        }
      }
    });
  });

  // Auto-hide success alerts
  setTimeout(() => {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      if (alert.classList.contains('show')) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }
    });
  }, 5000);
});
</script>
{% endblock %}