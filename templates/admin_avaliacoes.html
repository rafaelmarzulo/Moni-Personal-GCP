{% extends "admin_layout.html" %}
{% block title %}Todas Avaliações • MoniPersonal{% endblock %}
{% block page_title %}Todas as Avaliações{% endblock %}
{% block page_subtitle %}Visualize todas as avaliações registradas no sistema (últimas 100){% endblock %}

{% block content %}
<!-- Filtros -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card admin-card">
      <div class="card-header brand-gradient text-white">
        <h5 class="mb-0">
          <i class="bi bi-funnel me-2"></i>
          Filtros e Ordenação
        </h5>
      </div>
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-4">
            <label for="aluno" class="form-label">Filtrar por Aluno</label>
            <select name="aluno" id="aluno" class="form-select">
              <option value="">Todos os alunos</option>
              {% for aluno_nome in alunos_unicos %}
                <option value="{{ aluno_nome }}" {% if filtro_aluno == aluno_nome %}selected{% endif %}>
                  {{ aluno_nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="ordem" class="form-label">Ordenar por</label>
            <select name="ordem" id="ordem" class="form-select">
              <option value="data_desc" {% if ordem_atual == 'data_desc' %}selected{% endif %}>Data (Mais Recente)</option>
              <option value="data_asc" {% if ordem_atual == 'data_asc' %}selected{% endif %}>Data (Mais Antiga)</option>
              <option value="nome_asc" {% if ordem_atual == 'nome_asc' %}selected{% endif %}>Nome (A-Z)</option>
              <option value="nome_desc" {% if ordem_atual == 'nome_desc' %}selected{% endif %}>Nome (Z-A)</option>
              <option value="peso_desc" {% if ordem_atual == 'peso_desc' %}selected{% endif %}>Peso (Maior)</option>
              <option value="peso_asc" {% if ordem_atual == 'peso_asc' %}selected{% endif %}>Peso (Menor)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="limite" class="form-label">Limite</label>
            <select name="limite" id="limite" class="form-select">
              <option value="50" {% if limite_atual == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if limite_atual == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if limite_atual == 200 %}selected{% endif %}>200</option>
              <option value="500" {% if limite_atual == 500 %}selected{% endif %}>500</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-1"></i>
                Aplicar
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card admin-card">
      <div class="card-header brand-gradient text-white">
        <h5 class="mb-0">
          <i class="bi bi-clipboard-data-fill me-2"></i>
          Avaliações Registradas
        </h5>
      </div>
      <div class="card-body">
        {% if avaliacoes %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Aluno</th>
                <th>Data</th>
                <th>Peso (kg)</th>
                <th>Melhorias</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for avaliacao in avaliacoes %}
              <tr>
                <td><span class="badge bg-primary">#{{ avaliacao.id }}</span></td>
                <td>
                  <strong>{{ avaliacao.nome }}</strong>
                  {% if avaliacao.aluno %}
                    <br><small class="text-muted">{{ avaliacao.aluno.email }}</small>
                  {% endif %}
                </td>
                <td>
                  <i class="bi bi-calendar me-1"></i>
                  {{ avaliacao.data.strftime('%d/%m/%Y') if avaliacao.data else 'N/A' }}
                  <br><small class="text-muted">{{ avaliacao.data.strftime('%H:%M') if avaliacao.data else '' }}</small>
                </td>
                <td>
                  {% if avaliacao.peso_kg %}
                    <strong>{{ avaliacao.peso_kg }} kg</strong>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if avaliacao.melhorias_processadas %}
                    {% for melhoria in avaliacao.melhorias_processadas[:3] %}
                      <span class="badge bg-success me-1">{{ melhoria }}</span>
                    {% endfor %}
                    {% if avaliacao.melhorias_processadas|length > 3 %}
                      <span class="badge bg-secondary">+{{ avaliacao.melhorias_processadas|length - 3 }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Nenhuma</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="verDetalhes({{ avaliacao.id }})">
                      <i class="bi bi-eye"></i>
                      Ver
                    </button>
                    <a href="/admin/aluno/{{ avaliacao.nome }}" class="btn btn-outline-primary">
                      <i class="bi bi-person"></i>
                      Histórico
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mt-3">
          <p class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Mostrando as últimas 100 avaliações. Total no sistema: <strong>{{ avaliacoes|length }}</strong>
          </p>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="bi bi-clipboard-data display-1 text-muted"></i>
          <h4 class="text-muted mt-3">Nenhuma avaliação encontrada</h4>
          <p class="text-muted">Ainda não há avaliações registradas no sistema.</p>
          <a href="/admin/nova-avaliacao" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>
            Criar Primeira Avaliação
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver detalhes -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-clipboard-data me-2"></i>
          Detalhes da Avaliação
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detalhesContent">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function verDetalhes(avaliacaoId) {
  const modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
  const contentDiv = document.getElementById('detalhesContent');

  // Mostrar loading
  contentDiv.innerHTML = `
    <div class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-2">Carregando detalhes da avaliação...</p>
    </div>
  `;

  modal.show();

  try {
    const response = await fetch(`/admin/avaliacao/${avaliacaoId}`, {
      credentials: 'include'  // Inclui cookies de autenticação
    });

    if (!response.ok) {
      if (response.status === 404) {
        throw new Error('Avaliação não encontrada');
      } else if (response.status === 401 || response.status === 403) {
        throw new Error('Acesso negado. Faça login como administrador');
      } else {
        throw new Error(`Erro ${response.status}: ${response.statusText}`);
      }
    }

    const data = await response.json();

    // Renderizar detalhes
    contentDiv.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-primary mb-3">
            <i class="bi bi-person-fill me-2"></i>
            Informações Pessoais
          </h6>
          <table class="table table-sm">
            <tr><th>ID:</th><td>#${data.id}</td></tr>
            <tr><th>Nome:</th><td>${data.nome}</td></tr>
            <tr><th>E-mail:</th><td>${data.aluno_email || 'Não informado'}</td></tr>
            <tr><th>Data:</th><td>${data.data || 'N/A'}</td></tr>
            <tr><th>Idade:</th><td>${data.idade ? data.idade + ' anos' : 'N/A'}</td></tr>
            <tr><th>Altura:</th><td>${data.altura_cm ? data.altura_cm + ' cm' : 'N/A'}</td></tr>
            <tr><th>Peso:</th><td>${data.peso_kg ? data.peso_kg + ' kg' : 'N/A'}</td></tr>
          </table>
        </div>

        <div class="col-md-6">
          <h6 class="text-primary mb-3">
            <i class="bi bi-rulers me-2"></i>
            Medidas Corporais
          </h6>
          <table class="table table-sm">
            <tr><th>Pescoço:</th><td>${data.pescoco_cm ? data.pescoco_cm + ' cm' : 'N/A'}</td></tr>
            <tr><th>Cintura:</th><td>${data.cintura_cm ? data.cintura_cm + ' cm' : 'N/A'}</td></tr>
            <tr><th>Quadril:</th><td>${data.quadril_cm ? data.quadril_cm + ' cm' : 'N/A'}</td></tr>
          </table>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <h6 class="text-primary mb-3">
            <i class="bi bi-target me-2"></i>
            Objetivos de Melhoria
          </h6>
          ${data.melhorias && data.melhorias.length > 0 ?
            data.melhorias.map(m => `<span class="badge bg-success me-1 mb-1">${m}</span>`).join('') :
            '<span class="text-muted">Nenhuma melhoria especificada</span>'
          }
        </div>
      </div>
    `;

  } catch (error) {
    console.error('Erro ao carregar detalhes:', error);
    contentDiv.innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        ${error.message || 'Erro ao carregar detalhes da avaliação. Tente novamente.'}
      </div>
    `;
  }
}
</script>
{% endblock %}